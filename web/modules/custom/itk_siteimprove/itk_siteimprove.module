<?php
/**
 * @file
 * Contains hooks for itk_siteimprove.
 */

/**
 * Implements hook_preprocess_HOOK().
 */
function itk_siteimprove_preprocess_page(&$variables) {
  $settings = \Drupal::getContainer()->get('itk_siteimprove.settings');
  $config = \Drupal::config('itk_siteimprove.config');
  $excludeAdmin = $config->get('exclude_admin');
  $excludes = explode("\r\n", $config->get('excludes'));

  $key = $settings->get('key');

  // Ignore if key is not set.
  if (!$key) {
    return;
  }

  $trackPath = TRUE;
  $currentPath = \Drupal::service('path.current')->getPath();

  // Add admin pattern if selected.
  if ($excludeAdmin) {
    $excludes[] = '/^\/admin(.)*/';
  }

  // Check each exclude pattern.
  foreach ($excludes as $pattern) {
    if (preg_match($pattern, $currentPath)) {
      $trackPath = FALSE;
      break;
    }
  }

  // Inject script if allowed path.
  if ($trackPath) {
    $variables['#attached']['library'][] = 'itk_siteimprove/itk-siteimprove';
    $variables['#attached']['drupalSettings']['itk_siteimprove'] = [
      'key' => $key,
    ];
  }
}
